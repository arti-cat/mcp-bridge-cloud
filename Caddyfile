# Caddyfile for MCP Bridge Cloud
# Provides wildcard SSL and reverse proxy to tunnel relay service

*.mcp-bridge.xyz {
  # Automatic HTTPS with Let's Encrypt (production)
  tls {
    dns cloudflare {env.CLOUDFLARE_API_TOKEN}
  }

  # Enable logging
  log {
    output file /var/log/caddy/access.log
    format json
  }

  # Reverse proxy to tunnel relay service
  reverse_proxy 127.0.0.1:8080 {
    # Preserve original headers
    header_up Host {host}
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
  }
}

# Main domain (WebSocket tunnel + future dashboard)
mcp-bridge.xyz {
  # Automatic HTTPS with Let's Encrypt (production)
  tls {
    dns cloudflare {env.CLOUDFLARE_API_TOKEN}
  }

  # Enable logging
  log {
    output file /var/log/caddy/access.log
    format json
  }

  # Reverse proxy to tunnel relay service (WebSocket + HTTP)
  reverse_proxy 127.0.0.1:8080 {
    # Preserve original headers
    header_up Host {host}
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
    header_up X-Forwarded-Proto {scheme}
  }
}

# Health check endpoint (direct access, no SSL needed)
:2019 {
  respond /healthz "OK" 200
}
